# 游戏机制与系统设计

## 1. 核心哲学：需求驱动的模拟

TickTock Tribe 的世界是一个由被称为**村民 (Villagers)** 的自主代理 (Agent) 的行为所驱动的持续性模拟。村民所采取的每一个行动都源于一个层次化的需求集合。这种“需求驱动AI”构成了模拟的核心，创造出涌现行为和一个动态演化的世界。

模拟以离散的时间步长——**时间刻 (Ticks)**——来推进。所有的世界更新和代理决策都在这些Ticks内同步发生。

## 2. 世界与时间

### 2.1. 地形

世界是由各种地形瓦片组成的二维网格。主要的地形类型包括：
*   **平原 (PLAIN)**: 可建造的土地，可以被转化为农田。
*   **森林 (FOREST)**: `木材`和`种子`的来源。可以被清理成平原。
*   **水域 (WATER)**: 农业的必要条件。无法被修改。
*   **农田 (FARMLAND)**: 一个用于生产食物的多阶段瓦片。

### 2.2. 时间
-   时间以**时间刻 (Ticks)**来衡量。
-   一个可配置数量的时间刻构成一个**天 (Day)** (`time.ticks_per_day`)。
-   一个可配置数量的天数构成一个**年 (Year)** (`time.ticks_per_year`)。
-   时间的推移是全局性的，影响所有系统，包括村民衰老、作物生长和资源消耗。

## 3. 村民：变革的推动者

村民是模拟的核心代理。每个村民都是一个拥有独特属性集合的独立实体。

### 3.1. 属性
-   **性别 (Gender)**: `男性 (male)` 或 `女性 (female)`。
-   **年龄 (Age)**: 以时间刻 (`age_in_ticks`) 计量，并在游戏逻辑（如生育、工作能力）中转换为年。
-   **饥饿度 (Hunger)**: 一个从 `100` (饱腹) 到 `0` (饿死) 的数值。随时间推移而减少。
-   **状态 (Status)**: 村民当前的状态 (`空闲 (idle)`, `工作中 (working)`, `进食中 (eating)`等)。
-   **任务 (Task)**: 村民正在执行的具体的、需要持续一段时间的行动。

### 3.2. 寿命与衰老
-   村民的年龄随时间刻的流逝而线性增长。
-   **工作能力**:
    -   儿童 (`< 6` 岁) 和高龄老人 (`> 80` 岁) 不会工作。
    -   青年 (`6-18` 岁) 和长者 (`65-80` 岁) 的工作效率会降低。
-   **死亡**:
    -   **饿死**: 饥饿度达到 `0`。
    -   **老死**: 在65岁之后，死亡概率显著增加，在80岁左右达到顶峰。

### 3.3. 需求层次
村民的首要目标是满足他们的需求，其优先级如下：
1.  **紧急需求 (生存)**: 避免饿死。如果`饥饿度`低于一个临界阈值 (`ai.hunger_threshold_urgent`)，寻找食物将成为绝对的优先事项，会覆盖所有其他任务。
2.  **重要需求 (安全)**: 获得庇护所。一个没有家的村民会优先寻找或建造一个家。
3.  **机会性需求 (发展与传承)**: 当生存和安全得到满足时：
    -   **繁衍**: 如果条件满足，村民会尝试繁衍后代。
    -   **发展**: 收集资源 (`木材`, `种子`) 来改善定居点并建立盈余。

### 3.4. 繁衍
-   **条件**:
    -   两个不同性别的村民，居住在同一个房屋内。
    -   双方都必须在生育年龄范围内 (`18-45` 岁)。
    -   他们的年龄差距不能超过配置的限制 (`reproduction_age_gap`)。
    -   房屋必须有一个可用的空位 (`capacity`)。
    -   房屋的共享`仓库`必须有足够的食物储备 (`ai.food_reserve_for_reproduction`)。
-   **过程**: 繁衍是一项消耗大量食物的任务，并会为父母启动一段冷却时间 (`reproduction_cooldown_ticks`)。

## 4. 资源与仓储

### 4.1. 资源类型
-   **食物 (Food)**: 生存和繁衍的必需品。由农田产出。
-   **木材 (Wood)**: 主要的建筑材料。从森林中砍伐。
-   **种子 (Seeds)**: 用于种植新树。从森林中砍伐。

### 4.2. 统一的仓储系统 (房屋)
-   `houses` 表作为所有物品库存的通用模型。
-   **真实房屋 (Real House)**: 地图上一个具有 `x, y` 坐标的物理建筑，容量为 `4`，并为所有居民提供共享仓库。
-   **虚拟房屋 (Virtual House)**: 当一个村民不属于任何真实房屋时，代表其个人库存的一个抽象概念。它的坐标为 `NULL`，容量为 `1`。
-   每个村民**总是**与一个房屋（无论是真实的还是虚拟的）相关联，确保他们总能访问一个个人或共享的库存。

## 5. 建筑

### 5.1. 房屋
-   **功能**: 提供庇护所和共享仓库。是繁衍的先决条件。
-   **生命周期**:
    -   **建造**: 一项消耗`木材`的任务 (`house_build_cost_wood`)。
    -   **老化**: 拥有一个会随时间降低的`完好度 (integrity)`值。
    -   **倒塌**: 如果`完好度`降至 `0`，建筑将被摧毁。所有居民将变为“无家可归”（回归到一个新的虚拟房屋），储存的资源将平分给他们。

### 5.2. 农田
-   **生命周期**:
    1.  **开垦**: 村民将一块靠近`水域`的`平原`瓦片转化为`未耕种的农田 (FARM_UNTILLED)`。
    2.  **生长**: 瓦片自动转变为`生长中的农田 (FARM_GROWING)`。经过一段设定的时间 (`world.farmland_growth_ticks`) 后成熟。
    3.  **成熟**: 变为`成熟的农田 (FARM_MATURE)`，可以被收获。
    4.  **收获**: 村民执行一项任务，从瓦片上收集`食物`，该瓦片状态变回`未耕种的农田 (FARM_UNTILLED)`。

## 6. AI与任务系统

### 6.1. 决策制定
-   在每个决策点，AI逻辑会为所有`空闲 (idle)`状态的村民运行。
-   它会基于需求层次来评估行动的效用。例如，对于一个饥饿的村民来说，“收获食物”的效用极高，但对于一个饱食的村民来说则很低。
-   村民将执行当前可用的、效用最高的行动。

### 6.2. 任务执行
-   大多数行动不是瞬间完成的，而是被建模为**任务** (例如, `建造房屋`, `砍树`)。
-   当一个村民开始一项任务时，他们的`状态`变为`工作中 (working)`，并设置好`当前任务`和`任务进度`。
-   每个时间刻，`WorldUpdater` 会为所有工作中的村民增加`任务进度`。
-   当`任务进度`达到任务所需的时长时，任务完成，其效果被应用（例如，获得资源、改变地形），村民的`状态`恢复为`空闲 (idle)`。
-   紧急需求可以打断并覆盖当前的任务。